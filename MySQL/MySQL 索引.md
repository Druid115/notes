## MySQL 索引

### 索引的常见模型

- 哈希表，使用链表解决冲突问题，适用于只有等值查询的场景。
- 有序数组，在等值查询和范围查询场景中的性能都非常优秀，更新效率低，适用于静态存储引擎。
- 二叉搜索树，查询时间复杂度 O(log(N))，更新时间复杂度 O(log(N))。数据库存储大多不适用二叉树，因为树高过高，增大了查询时间，一般选择 N 叉树。



### InnoDB 的索引模型

InnoDB 使用了 B+ 树索引模型，索引类型分为主键索引和非主键索引。

- 主键索引的叶子节点存的是整行数据，也被称为聚簇索引（clustered index）。
- 非主键索引的叶子节点内容是主键的值，也被称为二级索引（secondary index）。

使用普通索引时，先搜索索引拿到主键值，再到主键索引搜索获取行数据（回表），因此，建议尽量使用主键索引。

一个数据页满了，按照 B+ 树算法会新增加一个数据页，叫做页分裂。空间利用率降低大概 50%，导致性能下降。当相邻的两个数据页利用率很低的时候会做数据页合并。

- 索引可能因为删除，或者页分裂等原因，导致数据页有空洞，重建索引的过程会创建一个新的索引，把数据按顺序插入，这样页面的利用率最高，也就是索引更紧凑、更省空间。**但是不论是删除主键还是重新创建主键，都会将整个表重建**。可以使用 `alter table T engine = InnoDB` 代替。

自增主键的插入数据模式，每次插入一条新记录都是追加操作，不涉及到挪动其他记录，也不会触发叶子节点的分裂。从性能和存储空间方面考量，自增主键往往是更合理的选择。



#### 覆盖索引

某索引已经覆盖了查询需求，称为覆盖索引。覆盖索引可以减少树的搜索次数，显著提升查询性能。例如将身份证号和姓名建立联合索引，在对高频的根据身份证号查询姓名的请求时，不会回表查询整行记录。当然，索引字段的维护总是有代价的。因此，在建立冗余索引来支持覆盖索引时就需要权衡考虑了。



#### 最左前缀原则

B+ 树这种索引结构，可以利用索引的 ”最左前缀“ 来定位记录，只要满足最左前缀，就可以利用索引来加速检索。最左前缀可以是联合索引的最左 N 个字段，也可以是字符串索引的最左 M 个字符。

由于最左前缀原则，在联合索引中，索引字段顺序的第一原则是：如果通过调整顺序，可以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。



#### 索引下推

在 MySQL 5.6 之前，只能根据最左前缀查询到 ID 后，再开始一个个回表，到主键索引上找出数据行，再对比字段值。MySQL 5.6 引入的索引下推优化（index condition pushdown)，可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。
